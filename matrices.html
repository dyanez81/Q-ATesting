<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrices de Prueba - QA Finsus</title>

    <!-- Estilos -->
    <link rel="icon" type="image/png" href="images/icons/favicon.ico" />
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        /* Contenedor principal con margen lateral */
        .main-content {
            margin-left: 230px;
            padding: 20px;
        }

        /* Animaci√≥n del formulario */
        #matrixFormContainer {
            display: none;
            transition: all 0.4s ease;
        }

        #matrixFormContainer.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <!-- üß† CONTENIDO PRINCIPAL -->
    <div class="main-content">
        <div class="container-fluid mt-4 mb-5">
            <!-- Bot√≥n para abrir modal de MATRIZ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="text-start" style="color:#23223F;">üìö Matrices</h3>
                <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#newMatrixModal">
                    ‚ûï Nueva matriz
                </button>
            </div>

            <!-- Tabla de matrices -->
            <div class="card shadow p-3">
                <h5 class="mb-3">Matrices registradas</h5>
                <table class="table table-striped align-middle" id="matricesTable">
                    <thead style="background:#23223F; color:white;">
                        <tr>
                            <th>Nombre</th>
                            <th>Descripci√≥n</th>
                            <th>Tester</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- üîπ Modal Nueva Matriz -->
            <div class="modal fade" id="newMatrixModal" tabindex="-1" aria-labelledby="newMatrixLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color:#23223F; color:white;">
                            <h5 class="modal-title" id="newMatrixLabel">üß© Registrar nueva matriz</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>

                        <form id="matrixForm">
                            <div class="modal-body">
                                <!-- MUY IMPORTANTE: name=... para que form.nombre funcione -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Nombre de la matriz</label>
                                        <input type="text" id="nombre" name="nombre" class="form-control"
                                            placeholder="Ej: Transferencias SPEI" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Interfaz</label>
                                        <input type="text" id="interfaz" name="interfaz" class="form-control"
                                            placeholder="Ej: App Finsus" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">M√≥dulo</label>
                                        <input type="text" id="modulo" name="modulo" class="form-control"
                                            placeholder="Ej: Transferencias" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Subm√≥dulo</label>
                                        <input type="text" id="submodulo" name="submodulo" class="form-control"
                                            placeholder="Ej: Cuenta registrada">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Descripci√≥n</label>
                                        <textarea id="descripcion" name="descripcion" class="form-control" rows="2"
                                            placeholder="Breve descripci√≥n de la matriz" required></textarea>
                                    </div>

                                    <!-- El JS usa este campo -->
                                    <input type="hidden" id="tester" name="tester">
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-dark">üíæ Guardar matriz</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- üîπ Modal Bugs -->
            <div class="modal fade" id="bugsModal" tabindex="-1" aria-labelledby="bugsLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg ">
                    <div class="modal-content" style="border-radius: 15px;">
                        <div class="modal-header" style="background-color:#179DE9; color:white;">
                            <h5 class="modal-title fw-semibold" id="bugsLabel">üêû Seguimiento de Bugs</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>

                        <div class="modal-body">
                            <div class="mb-3">
                                <h6 class="fw-semibold">Matriz: <span id="bugMatrixName" class="text-primary"></span>
                                </h6>
                            </div>

                            <!-- üêõ Lista de bugs -->
                            <div class="table-responsive mb-4">
                                <table class="table table-striped align-middle" id="bugsTable">
                                    <thead>
                                        <tr style="background:#23223F; color:white;">
                                            <th>T√≠tulo</th>
                                            <th>Descripci√≥n</th>
                                            <th>Estatus</th>
                                            <th>Reportado por</th>
                                            <th>Asignado a</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>

                            <!-- üÜï Formulario nuevo bug -->
                            <form id="bugForm">
                                <h6 class="fw-semibold mb-3">Registrar nuevo bug</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">T√≠tulo del bug</label>
                                        <input type="text" id="bugTitulo" class="form-control"
                                            placeholder="Ej: Error al validar token" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Asignado a</label>
                                        <input type="text" id="bugAsignado" class="form-control"
                                            placeholder="Ej: dev@finsus.com">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Descripci√≥n</label>
                                        <textarea id="bugDescripcion" class="form-control" rows="2"
                                            placeholder="Detalles del error encontrado..." required></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estatus</label>
                                        <select id="bugEstatus" class="form-controls" required>
                                            <option value="Abierto">Abierto</option>
                                            <option value="En progreso">En progreso</option>
                                            <option value="Resuelto">Resuelto</option>
                                            <option value="Rechazado">Rechazado</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Reportado por</label>
                                        <input type="text" id="bugReportadoPor" class="form-control" readonly>
                                    </div>
                                    <div class="col-md-4 text-end align-self-end">
                                        <button type="submit" class="btn btn-dark px-4">üíæ Guardar bug</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-outline-secondary"
                                data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üîß Scripts -->
            <script type="module">
                import { loadNavbar } from './js/ui.js';
                import { auth, db } from './js/firebase-config.js';
                import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
                import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';
                import { logout } from './js/auth.js';

                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Sesi√≥n expirada',
                            text: 'Por favor, inicia sesi√≥n nuevamente.',
                            confirmButtonColor: '#23223F'
                        }).then(() => window.location.href = 'index.html');
                    } else if (window.currentUser && window.currentUser.role === 'Desarrollador' && window.location.pathname !== '/bugs-dashboard.html') {
                        Swal.fire({
                            icon: 'info',
                            title: 'Acceso restringido',
                            text: 'Tu rol solo permite acceso al m√≥dulo de bugs.',
                            confirmButtonColor: '#23223F'
                        }).then(() => window.location.href = 'bugs-dashboard.html');
                    }
                });
                

                // 1Ô∏è‚É£ Cargar barra y header global
                await loadNavbar();

                // 2Ô∏è‚É£ Mostrar info de usuario en header
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const ref = doc(db, 'users', user.uid);
                        const snap = await getDoc(ref);
                        if (snap.exists()) {
                            const data = snap.data();
                            document.getElementById('userName').textContent = data.name || user.email;
                            document.getElementById('userRole').textContent = data.role || 'Tester';
                        }
                    }
                });

                // 3Ô∏è‚É£ Hacer accesible logout()
                window.logout = logout;
            </script>
            <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

            <script type="module" src="./js/auth.js"></script>
            <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
            <script type="module" src="./js/matrices.js"></script>
</body>

</html>